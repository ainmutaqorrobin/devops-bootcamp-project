# Ansible Configuration

This directory contains Ansible playbooks and roles for configuring the DevOps infrastructure.

## Directory Structure

```
ansible/
├── ansible.cfg          # Ansible configuration
├── inventory.ini        # Server inventory (auto-generated by Terraform)
├── playbook.yml         # Main playbook
├── roles/               # Ansible roles
│   ├── common/          # Basic server setup
│   ├── docker/          # Docker installation
│   ├── webapp/          # Web application deployment
│   └── monitoring/      # Monitoring stack setup
└── README.md           # This file
```

## Important Notes

- **`inventory.ini` is auto-generated** by Terraform (`terraform/ansible.tf`)
- After running `terraform apply`, the inventory file will contain actual IP addresses
- Do not edit `inventory.ini` manually - it will be overwritten by Terraform

## Prerequisites

1. AWS CLI configured with proper credentials
2. Ansible installed on your local machine
3. Required Ansible collections installed (see Setup below)
4. AWS infrastructure deployed via Terraform
5. SSH access to servers (SSH key is automatically generated by Terraform)

## Setup

### 1. Install Required Ansible Collections

**⚠️ REQUIRED: Install collections before proceeding**

```bash
# Install required collections
ansible-galaxy collection install -r requirements.yml

# Or install individually
ansible-galaxy collection install community.docker
```

### 2. Deploy Infrastructure with Terraform

Deploy the infrastructure which will automatically:
- Generate SSH key pair
- Save private key to `ansible/ansible-key.pem`
- Create AWS key pair
- Attach key to all EC2 instances
- Generate inventory file with SSH configuration

```bash
cd terraform
terraform init
terraform apply
```

### 3. Verify SSH Key

After Terraform applies, verify the SSH key was created:

```bash
# Check that the key file exists and has correct permissions
ls -l ansible/ansible-key.pem
# Should show: -r-------- (400 permissions)
```

## Usage

### 1. Install Collections (REQUIRED)

```bash
ansible-galaxy collection install community.docker
```

### 2. Verify SSH Connectivity

Test SSH connectivity to all servers:

```bash
# Test connection to web server
ansible webservers -m ping

# Test connection to ansible controller
ansible ansible_controller -m ping

# Test connection to monitoring server
ansible monitoring_servers -m ping
```

### 3. Test Playbook Syntax (Optional)

Before deploying to production, test playbook syntax locally:

```bash
# Test playbook syntax with local connections
ansible-playbook -i inventory.test.ini --syntax-check playbook.yml

# Test with local execution (for role validation)
ansible-playbook -i inventory.test.ini --connection=local playbook.yml
```

### 2. Test Connectivity

```bash
ansible all -m ping
```

### 3. Run the Complete Playbook

```bash
ansible-playbook playbook.yml
```

### 4. Run Individual Roles

```bash
# Configure common settings on all servers
ansible-playbook playbook.yml --tags common

# Install Docker on all servers
ansible-playbook playbook.yml --tags docker

# Deploy web application
ansible-playbook playbook.yml --tags webapp

# Setup monitoring
ansible-playbook playbook.yml --tags monitoring
```

## What Gets Configured

- **Common**: Updates packages, installs essentials on all servers
- **Docker**: Installs Docker Engine and Compose on all servers
- **Webapp**: Deploys the application from ECR as Docker container
- **Monitoring**: Sets up Prometheus and Grafana stack

## Access URLs (after deployment)

- **Web Application**: `http://<web-server-public-ip>`
- **Grafana**: `http://<monitoring-server-private-ip>:3000` (admin/admin)
- **Prometheus**: `http://<monitoring-server-private-ip>:9090`

## Troubleshooting

### SSH Connection Issues

**SSH connections fail / Connection refused**
- **Solution**: Verify SSH key permissions: `chmod 400 ansible/ansible-key.pem`
- **Verify**: Check security groups allow SSH (port 22) from your location
- **Note**: Private servers (ansible_controller, monitoring_server) are only accessible from within the VPC

**"Permission denied (publickey)"**
- **Solution**: Ensure the SSH key file exists: `ls -l ansible/ansible-key.pem`
- **Verify**: Check key permissions: `chmod 400 ansible/ansible-key.pem`
- **Check**: Verify Terraform created the key and attached it to instances

**General Troubleshooting Steps:**

1. Check SSH connectivity: `ansible all -m ping`
2. Test SSH manually: `ssh -i ansible-key.pem ubuntu@<server-ip>`
3. Verify inventory file: `cat inventory.ini`
4. View detailed output: `ansible-playbook playbook.yml -v`
5. Run specific tasks: `ansible-playbook playbook.yml --step`
6. Check logs: Check `/var/log/cloud-init-output.log` on servers

### Network Access

- **Web Server**: Accessible via public IP (SSH from internet if security group allows)
- **Ansible Controller & Monitoring Server**: Only accessible from within VPC (10.0.0.0/24)
- **Note**: If running Ansible from your local machine, you can only directly access the web server. To access private servers, you may need to:
  - Use a bastion host
  - Run Ansible from the ansible_controller instance
  - Update security groups to allow SSH from your IP