---
- name: Update package cache
  apt:
    update_cache: yes

- name: Install essential packages
  apt:
    name:
      - curl
      - wget
      - vim
      - htop
      - net-tools
      - unzip
    state: present

- name: Check if AWS CLI is already installed
  command: aws --version
  register: aws_cli_check
  failed_when: false
  changed_when: false

- name: Download AWS CLI v2 installer
  get_url:
    url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
    dest: /tmp/awscliv2.zip
    mode: '0644'
  when: aws_cli_check.rc != 0

- name: Unzip AWS CLI installer
  unarchive:
    src: /tmp/awscliv2.zip
    dest: /tmp
    remote_src: yes
  when: aws_cli_check.rc != 0

- name: Install AWS CLI v2
  command: /tmp/aws/install
  args:
    creates: /usr/local/bin/aws
  when: aws_cli_check.rc != 0

- name: Clean up AWS CLI installer files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/awscliv2.zip
    - /tmp/aws
  when: aws_cli_check.rc != 0

- name: Verify AWS CLI installation
  command: aws --version
  register: aws_cli_version
  changed_when: false

- name: Display AWS CLI version
  debug:
    msg: "AWS CLI installed: {{ aws_cli_version.stdout }}"

- name: Configure timezone
  timezone:
    name: Asia/Singapore

- name: Ensure SSM Agent is running
  service:
    name: amazon-ssm-agent
    state: started
    enabled: yes
  ignore_errors: true

- name: "Alternative: Start SSM Agent via snap if service name differs"
  service:
    name: snap.amazon-ssm-agent.amazon-ssm-agent
    state: started
    enabled: yes
  ignore_errors: true

- name: Check SSM Agent status
  command: systemctl status amazon-ssm-agent || systemctl status snap.amazon-ssm-agent.amazon-ssm-agent
  register: ssm_status
  failed_when: false

- name: Display SSM Agent status
  debug:
    msg: "SSM Agent status: {{ ssm_status.stdout | default('Service not found') }}"

- name: Verify SSM Agent is running
  command: systemctl status amazon-ssm-agent
  register: ssm_status
  failed_when: false

- name: Show SSM Agent status
  debug:
    msg: "SSM Agent status: {{ ssm_status.stdout | default('Not available') }}"