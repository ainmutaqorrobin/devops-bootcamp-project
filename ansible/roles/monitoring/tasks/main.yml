---
- name: Create monitoring directory
  file:
    path: /opt/monitoring
    state: directory

- name: Create Prometheus configuration
  copy:
    dest: /opt/monitoring/prometheus.yml
    content: |
      global:
        scrape_interval: 15s

      scrape_configs:
        - job_name: 'web-server'
          static_configs:
            - targets: ['10.0.0.5:9100']

- name: Create docker-compose.yml for monitoring
  copy:
    dest: /opt/monitoring/docker-compose.yml
    content: |
      version: '3.8'

      services:
        prometheus:
          image: prom/prometheus:latest
          container_name: prometheus
          volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml
          ports:
            - "9090:9090"
          restart: always

        grafana:
          image: grafana/grafana:latest
          container_name: grafana
          ports:
            - "3000:3000"
          restart: always
          environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin

        node-exporter:
          image: prom/node-exporter:latest
          container_name: node-exporter
          ports:
            - "9100:9100"
          restart: always
          volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro

- name: Start monitoring stack
  docker_compose:
    project_src: /opt/monitoring
    state: present